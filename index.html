<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Fork Manager - BPMs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .config-section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .config-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-sync {
            background: linear-gradient(45deg, #48bb78, #38a169);
        }

        .btn-sync:hover {
            box-shadow: 0 10px 20px rgba(72, 187, 120, 0.3);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .forks-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        }

        .fork-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .fork-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .fork-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .fork-card.outdated::before {
            background: linear-gradient(45deg, #f56565, #e53e3e);
        }

        .fork-card.updated::before {
            background: linear-gradient(45deg, #48bb78, #38a169);
        }

        .fork-header {
            /*display: flex;*/
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .fork-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .fork-url {
            font-size: 0.9rem;
            color: #718096;
            text-decoration: none;
        }

        .fork-url:hover {
            color: #667eea;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-updated {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-outdated {
            background: #fed7d7;
            color: #742a2a;
        }

        .fork-stats {
            display: flex;
            justify-content: center;
            margin: 15px 0;
            font-size: 0.9rem;
            color: #718096;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            display: block;
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a5568;
        }

        .fork-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.8rem;
            flex: 1;
        }

        .error-message {
            background: #fed7d7;
            color: #742a2a;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #e53e3e;
            line-height: 1.5;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #38a169;
            line-height: 1.5;
        }

        .info-message {
            background: #bee3f8;
            color: #2a4365;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #3182ce;
            line-height: 1.5;
        }

        .error-message small, .success-message small, .info-message small {
            display: block;
            margin-top: 8px;
            opacity: 0.8;
            font-size: 0.9em;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .debug-section {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #4a5568;
        }

        .debug-toggle {
            background: #4a5568;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }

        .debug-toggle:hover {
            background: #718096;
        }

        .comparison-details {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .comparison-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .comparison-row:last-child {
            border-bottom: none;
        }

        .comparison-label {
            font-weight: 600;
            color: #4a5568;
        }

        .comparison-value {
            color: #2d3748;
            font-family: monospace;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .config-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .forks-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ GitHub Fork Manager</h1>
            <p>Gestiona y sincroniza todos los forks de tu repositorio BPMs</p>
        </div>

        <div class="config-section">
            <div class="config-row">
                <div class="input-group">
                    <label for="token">Token de GitHub (Personal Access Token)</label>
                    <input type="password" id="token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                </div>
                <button class="btn" onclick="loadForks()" id="loadBtn">Cargar Forks</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Cargando informaci√≥n de los forks...</p>
        </div>

        <div id="messages"></div>

        <div id="bulkActions" class="config-section" style="display: none;">
            <div class="config-row">
                <div style="flex: 1;">
                    <h3 style="margin: 0; color: #4a5568;">Acciones masivas</h3>
                    <p style="margin: 5px 0 0 0; color: #718096; font-size: 0.9rem;">Sincroniza m√∫ltiples forks de una vez</p>
                </div>
                <button class="btn btn-sync" onclick="syncAllOutdated()" id="syncAllBtn">
                    Sincronizar todos los desactualizados
                </button>
                <button class="btn" onclick="exportDebugInfo()" style="background: #4a5568;">
                    üìã Exportar Debug
                </button>
            </div>
        </div>

        <div id="forksContainer" class="forks-grid"></div>
    </div>

    <script>
        let currentForks = [];

        // FUNCIONALIDAD COMPLETAMENTE REDISE√ëADA PARA EVITAR PROBLEMAS DE INICIALIZACI√ìN
        
        function showMessage(message, type = 'error') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type}-message`;
            messageDiv.innerHTML = message;
            
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 8000);
        }

        function showLoading(show = true) {
            const loading = document.getElementById('loading');
            const loadBtn = document.getElementById('loadBtn');
            
            if (show) {
                loading.classList.add('show');
                loadBtn.disabled = true;
            } else {
                loading.classList.remove('show');
                loadBtn.disabled = false;
            }
        }

        function hideForks() {
            const container = document.getElementById('forksContainer');
            container.classList.add('hidden');
        }

        function showForks() {
            const container = document.getElementById('forksContainer');
            container.classList.remove('hidden');
        }

        async function makeGitHubRequest(url, method = 'GET', body = null) {
            const token = document.getElementById('token').value.trim();
            
            if (!token) {
                throw new Error('Por favor, ingresa tu token de GitHub');
            }

            const options = {
                method,
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                }
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(url, options);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                const error = new Error(JSON.stringify({
                    status: response.status,
                    statusText: response.statusText,
                    message: errorData.message || `Error ${response.status}: ${response.statusText}`,
                    documentation_url: errorData.documentation_url,
                    errors: errorData.errors
                }));
                throw error;
            }

            return await response.json();
        }

        // FUNCI√ìN PRINCIPAL - USANDO VALORES CONSTANTES
        async function loadForks() {
            // VALORES CONSTANTES - SIN CAMPOS EN LA INTERFAZ
            const owner = 'bpm-co';
            const repo = 'BPMs';

            const token = document.getElementById('token').value.trim();
            if (!token) {
                showMessage('Por favor, ingresa tu token de GitHub');
                return;
            }

            showLoading(true);
            currentForks = []; // Reset
            
            try {
                // Obtener informaci√≥n del repositorio padre
                const parentRepo = await makeGitHubRequest(`https://api.github.com/repos/${owner}/${repo}`);
                
                // Obtener lista de forks
                const forks = await makeGitHubRequest(`https://api.github.com/repos/${owner}/${repo}/forks`);

                if (!Array.isArray(forks) || forks.length === 0) {
                    document.getElementById('forksContainer').innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            <h3>No se encontraron forks</h3>
                            <p>Este repositorio a√∫n no tiene forks asociados.</p>
                        </div>
                    `;
                    return;
                }

                // PROCESAMIENTO SECUENCIAL - UNO A LA VEZ
                for (let i = 0; i < forks.length; i++) {
                    try {
                        const processedFork = await processIndividualFork(forks[i], i, owner, repo, parentRepo);
                        currentForks.push(processedFork);
                    } catch (error) {
                        console.error(`‚ùå Error processing fork ${i + 1}:`, error.message);
                        const errorFork = createSafeForkObject(forks[i], i, error);
                        currentForks.push(errorFork);
                    }
                }

                renderForks();
                showMessage(`‚úÖ Procesados ${currentForks.length} forks exitosamente`, 'success');
                
            } catch (error) {
                console.error('‚ùå Critical error in loadForks:', error);
                showMessage(`Error cr√≠tico: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // FUNCI√ìN PARA PROCESAR UN FORK INDIVIDUAL - USANDO M√öLTIPLES M√âTODOS
        async function processIndividualFork(rawFork, index, owner, repo, parentRepo) {
            // CREAR OBJETO RESULTADO CON TODOS LOS VALORES POR DEFECTO
            const safeResult = createSafeForkObject(rawFork, index, null);

            // Validaciones b√°sicas
            if (!rawFork?.full_name || !rawFork?.owner?.login) {
                throw new Error('Fork data incomplete');
            }

            // Obtener detalles del fork
            const forkDetails = await makeGitHubRequest(`https://api.github.com/repos/${rawFork.full_name}`);
            const defaultBranch = forkDetails.default_branch || rawFork.default_branch || 'main';

            // Actualizar informaci√≥n b√°sica
            safeResult.default_branch = defaultBranch;
            safeResult.forkDetails = forkDetails;

            let comparisonResult = null;
            let methodUsed = 'unknown';

            // M√âTODO 1: Intentar GraphQL API de GitHub (m√°s precisa)
            try {
                comparisonResult = await getComparisonWithGraphQL(owner, repo, rawFork, defaultBranch, parentRepo.default_branch);
                methodUsed = 'graphql';
            } catch (error) {                
                // M√âTODO 2: Comparaci√≥n directa de commits (m√°s fiable que comparaciones)
                try {
                    comparisonResult = await getComparisonWithCommits(owner, repo, rawFork, defaultBranch, parentRepo.default_branch);
                    methodUsed = 'commits';
                } catch (error2) {
                    console.log(`  ‚ùå Commit comparison failed: ${error2.message}`);
                    
                    // M√âTODO 3: API REST tradicional (fallback)
                    console.log(`  üîÑ Falling back to REST API...`);
                    comparisonResult = await fallbackToApiComparison(rawFork, owner, repo, defaultBranch, parentRepo.default_branch);
                    methodUsed = 'rest-api';
                    console.log(`  ‚úÖ REST API success:`, comparisonResult);
                }
            }

            // CALCULAR ESTADOS BASADOS EN LA INFORMACI√ìN OBTENIDA - L√ìGICA CORREGIDA SEG√öN FEEDBACK
            const behindCount = comparisonResult.behind || 0;  // Commits que le faltan al fork del padre
            const aheadCount = comparisonResult.ahead || 0;    // Commits propios del fork que el padre no tiene
            
            // L√ìGICA CORREGIDA SEG√öN COMPORTAMIENTO REAL DE GITHUB:
            // GitHub considera un fork "out-of-date" SOLAMENTE cuando tiene commits adelante (commits propios)
            // Un fork que solo tiene commits atr√°s est√° "actualizado" pero necesita sync
            
            const needsSync = behindCount > 0;                 // Si le faltan commits del padre
            const hasOwnCommits = aheadCount > 0;              // Si tiene commits propios
            const isUpToDate = aheadCount === 0;               // Actualizado si NO tiene commits propios
            const isGitHubOutOfDate = aheadCount > 0;          // GitHub lo marca desactualizado solo si tiene commits propios
            
            let detailedStatus = 'up-to-date';
            if (hasOwnCommits && needsSync) detailedStatus = 'diverged';
            else if (hasOwnCommits) detailedStatus = 'ahead'; // Este es el "desactualizado" de GitHub
            else if (needsSync) detailedStatus = 'behind';    // Este est√° "actualizado" pero necesita sync

            // ACTUALIZAR RESULTADO CON VALORES CALCULADOS
            safeResult.isUpToDate = isUpToDate;
            safeResult.needsSync = needsSync;
            safeResult.hasOwnCommits = hasOwnCommits;
            safeResult.isGitHubOutOfDate = isGitHubOutOfDate;  // Solo true si tiene commits propios
            safeResult.behindBy = behindCount;
            safeResult.aheadBy = aheadCount;
            safeResult.status = comparisonResult.status || detailedStatus;
            safeResult.detailedStatus = detailedStatus;
            safeResult.error = false;

            // Actualizar debug info con informaci√≥n del m√©todo usado
            safeResult.debugInfo = createDebugInfoWithMethod(
                rawFork, owner, repo, parentRepo, forkDetails, 
                comparisonResult, methodUsed, behindCount, aheadCount
            );

            return safeResult;
        }

        // M√âTODO 1: GraphQL API para obtener comparaci√≥n m√°s precisa
        async function getComparisonWithGraphQL(owner, repo, fork, forkBranch, parentBranch) {
            const token = document.getElementById('token').value.trim();
            
            const graphqlQuery = {
                query: `
                    query CompareRefs($owner: String!, $repo: String!, $forkOwner: String!, $forkRepo: String!, $baseBranch: String!, $headBranch: String!) {
                        repository(owner: $owner, name: $repo) {
                            object(expression: $baseBranch) {
                                ... on Commit {
                                    oid
                                }
                            }
                        }
                        forkRepo: repository(owner: $forkOwner, name: $forkRepo) {
                            object(expression: $headBranch) {
                                ... on Commit {
                                    oid
                                }
                            }
                            compareWithParent: object(expression: $headBranch) {
                                ... on Commit {
                                    history(first: 100) {
                                        totalCount
                                        nodes {
                                            oid
                                        }
                                    }
                                }
                            }
                        }
                    }
                `,
                variables: {
                    owner: owner,
                    repo: repo,
                    forkOwner: fork.owner.login,
                    forkRepo: fork.name,
                    baseBranch: parentBranch,
                    headBranch: forkBranch
                }
            };

            const response = await fetch('https://api.github.com/graphql', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(graphqlQuery)
            });

            if (!response.ok) {
                throw new Error(`GraphQL API failed: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.errors) {
                throw new Error(`GraphQL errors: ${result.errors.map(e => e.message).join(', ')}`);
            }

            // Procesar resultado de GraphQL para extraer informaci√≥n de comparaci√≥n
            const parentCommit = result.data.repository?.object?.oid;
            const forkCommit = result.data.forkRepo?.object?.oid;
            
            if (!parentCommit || !forkCommit) {
                throw new Error('Could not get commit SHAs from GraphQL');
            }

            // Ahora usar la API REST con los SHAs espec√≠ficos para comparaci√≥n
            const compareUrl = `https://api.github.com/repos/${owner}/${repo}/compare/${parentCommit}...${forkCommit}`;
            const compareResult = await makeGitHubRequest(compareUrl);

            return {
                ahead: compareResult.behind_by || 0,
                behind: compareResult.ahead_by || 0,
                status: compareResult.status,
                source: 'graphql-enhanced',
                parentSha: parentCommit,
                forkSha: forkCommit,
                compareUrl: compareUrl
            };
        }

        // M√âTODO 2: Comparaci√≥n directa usando commits m√°s recientes
        async function getComparisonWithCommits(owner, repo, fork, forkBranch, parentBranch) {        
            // Obtener √∫ltimo commit del repositorio padre
            const parentCommits = await makeGitHubRequest(`https://api.github.com/repos/${owner}/${repo}/commits?sha=${parentBranch}&per_page=1`);
            const parentLatestSha = parentCommits[0]?.sha;
            
            // Obtener √∫ltimo commit del fork
            const forkCommits = await makeGitHubRequest(`https://api.github.com/repos/${fork.full_name}/commits?sha=${forkBranch}&per_page=1`);
            const forkLatestSha = forkCommits[0]?.sha;
            
            if (!parentLatestSha || !forkLatestSha) {
                throw new Error('Could not get latest commit SHAs');
            }

            // Si los SHA son iguales, est√° actualizado
            if (parentLatestSha === forkLatestSha) {
                return {
                    ahead: 0,
                    behind: 0,
                    status: 'identical',
                    source: 'commit-comparison',
                    parentSha: parentLatestSha,
                    forkSha: forkLatestSha
                };
            }

            // Comparar usando los SHA espec√≠ficos
            const compareUrl = `https://api.github.com/repos/${owner}/${repo}/compare/${parentLatestSha}...${forkLatestSha}`;
            const compareResult = await makeGitHubRequest(compareUrl);

            return {
                ahead: compareResult.behind_by || 0,  // Fork est√° adelante
                behind: compareResult.ahead_by || 0,  // Fork est√° atr√°s
                status: compareResult.status,
                source: 'commit-comparison',
                parentSha: parentLatestSha,
                forkSha: forkLatestSha,
                compareUrl: compareUrl,
                rawResult: compareResult
            };
        }

        // FUNCI√ìN PARA CREAR DEBUG INFO CON INFORMACI√ìN DEL M√âTODO USADO
        function createDebugInfoWithMethod(fork, owner, repo, parentRepo, forkDetails, comparisonInfo, method, behindBy, aheadBy) {
            return {
                parentRepo: {
                    name: `${owner}/${repo}`,
                    default_branch: parentRepo.default_branch,
                    updated_at: parentRepo.updated_at
                },
                fork: {
                    name: fork.full_name,
                    default_branch: forkDetails?.default_branch || fork.default_branch,
                    updated_at: fork.updated_at,
                    parent_updated_at: forkDetails?.updated_at || 'N/A'
                },
                method: {
                    used: method,
                    source: comparisonInfo.source,
                    comparison_url: comparisonInfo.compareUrl || comparisonInfo.comparisonUrl || 'N/A',
                    parent_sha: comparisonInfo.parentSha || 'N/A',
                    fork_sha: comparisonInfo.forkSha || 'N/A'
                },
                comparison: {
                    status: comparisonInfo.status || 'unknown',
                    ahead_from_source: comparisonInfo.ahead || 0,
                    behind_from_source: comparisonInfo.behind || 0,
                    final_ahead: aheadBy,
                    final_behind: behindBy,
                    comparison_direction: 'Enhanced method comparison'
                },
                githubWebComparison: `https://github.com/${owner}/${fork.name}/compare/${owner}:${fork.name}:${forkDetails?.default_branch || 'dev'}...${owner}:${repo}:${parentRepo.default_branch}`,
                note: `Using ${method} method for more accurate comparison`
            };
        }

        // FUNCI√ìN FALLBACK PARA USAR LA API DE COMPARACI√ìN SI EL ENDPOINT DE GITHUB FALLA
        async function fallbackToApiComparison(fork, owner, repo, forkBranch, parentBranch) {
            // Preparar URLs de comparaci√≥n (m√©todo original)
            const comparisonUrls = buildComparisonUrls(fork, owner, repo, forkBranch, parentBranch);
            
            // Intentar comparaci√≥n con API
            for (let urlIndex = 0; urlIndex < comparisonUrls.length; urlIndex++) {
                try {
                    const comparisonResult = await makeGitHubRequest(comparisonUrls[urlIndex]);
                    // Convertir resultado de API al formato esperado
                    return {
                        ahead: comparisonResult.behind_by || 0,  // Fork est√° adelante
                        behind: comparisonResult.ahead_by || 0,  // Fork est√° atr√°s
                        status: comparisonResult.status,
                        source: 'api-comparison',
                        apiResult: comparisonResult
                    };
                } catch (error) {
                    console.log(`    ‚ùå API attempt ${urlIndex + 1} failed: ${error.message}`);
                }
            }
            
            throw new Error('All comparison methods failed');
        }

        // FUNCI√ìN PARA CREAR OBJETO SEGURO - EVITA REFERENCIAS UNDEFINED
        function createSafeForkObject(rawFork, index, error) {
            const forkName = rawFork?.full_name || `Fork-${index}`;
            
            return {
                // Propiedades b√°sicas del fork
                id: rawFork?.id || index,
                name: rawFork?.name || forkName.split('/').pop() || `fork-${index}`,
                full_name: forkName,
                html_url: rawFork?.html_url || `https://github.com/${forkName}`,
                description: rawFork?.description || '',
                private: rawFork?.private || false,
                owner: rawFork?.owner || { login: 'unknown' },
                default_branch: rawFork?.default_branch || 'main',
                created_at: rawFork?.created_at || '',
                updated_at: rawFork?.updated_at || '',
                
                // Estados calculados - TODOS CON VALORES POR DEFECTO
                error: !!error,
                errorMessage: error?.message || null,
                isUpToDate: null,
                needsSync: false,
                hasOwnCommits: false,
                isGitHubOutOfDate: false,  // Nueva propiedad para estado seg√∫n GitHub
                behindBy: 0,
                aheadBy: 0,
                status: error ? 'error' : 'unknown',
                detailedStatus: error ? 'error' : 'unknown',
                
                // Objetos complejos con estructura completa
                comparison: null,
                forkDetails: null,
                rawApiData: { 
                    api_ahead_by: 0, 
                    api_behind_by: 0, 
                    comparison_direction: 'fork...parent' 
                },
                debugInfo: {
                    parentRepo: { name: 'N/A', default_branch: 'N/A', updated_at: 'N/A' },
                    fork: { name: forkName, default_branch: 'N/A', updated_at: 'N/A' },
                    comparison: { status: 'pending', api_ahead_by: 0, api_behind_by: 0, fork_behind_by: 0, fork_ahead_by: 0 },
                    comparisonUrl: 'Not attempted',
                    urlsAttempted: [],
                    error: error?.message || null
                }
            };
        }

        // FUNCI√ìN PARA CONSTRUIR URLs DE COMPARACI√ìN
        function buildComparisonUrls(fork, owner, repo, forkBranch, parentBranch) {
            const urls = [];
            
            if (fork.owner.login === owner) {
                // Misma organizaci√≥n - m√∫ltiples formatos
                urls.push(
                    `https://api.github.com/repos/${owner}/${repo}/compare/${owner}:${fork.name}:${forkBranch}...${owner}:${repo}:${parentBranch}`,
                    `https://api.github.com/repos/${owner}/${repo}/compare/${fork.name}:${forkBranch}...${parentBranch}`,
                    `https://api.github.com/repos/${owner}/${repo}/compare/${fork.owner.login}:${fork.name}:${forkBranch}...${parentBranch}`
                );
            } else {
                // Diferente organizaci√≥n
                urls.push(
                    `https://api.github.com/repos/${owner}/${repo}/compare/${fork.owner.login}:${forkBranch}...${parentBranch}`,
                    `https://api.github.com/repos/${owner}/${repo}/compare/${fork.owner.login}:${fork.name}:${forkBranch}...${owner}:${repo}:${parentBranch}`
                );
            }
            
            return urls;
        }

        function renderForks() {
            const container = document.getElementById('forksContainer');
            const bulkActions = document.getElementById('bulkActions');
            
            // Mostrar acciones masivas si hay forks que necesitan sincronizaci√≥n (commits atr√°s > 0)
            const forksNeedingSync = currentForks.filter(fork => fork.needsSync && !fork.error);
            if (forksNeedingSync.length > 0) {
                bulkActions.style.display = 'block';
                const syncAllBtn = document.getElementById('syncAllBtn');
                syncAllBtn.textContent = `Sincronizar ${forksNeedingSync.length} fork${forksNeedingSync.length > 1 ? 's' : ''} que necesita${forksNeedingSync.length > 1 ? 'n' : ''} sync`;
            } else {
                bulkActions.style.display = 'none';
            }
            
            // Helper functions
            const getStatusClass = (fork) => {
                if (fork.error) return 'error';
                // L√ìGICA CORREGIDA: Solo desactualizado si tiene commits adelante (commits propios)
                if (fork.isGitHubOutOfDate) return 'outdated';
                return 'updated';
            };
            
            const getStatusText = (fork) => {
                if (fork.error) return 'Error';
                
                // L√ìGICA SIMPLIFICADA CON TEXTO MEJORADO
                if (fork.aheadBy > 0) {
                    return `${fork.aheadBy} Commits pendientes - DESACTUALIZADO`;
                } else {
                    return '‚úÖ Actualizado';
                }
            };
            
            const getComparisonUrl = (fork) => {
                return fork.debugInfo?.githubWebComparison || '#';
            };
            
            container.innerHTML = currentForks.map(fork => `
                <div class="fork-card ${getStatusClass(fork)}" id="fork-${fork.owner?.login || 'unknown'}-${fork.name || 'unknown'}">
                    <div class="fork-header">
                        <div style="padding-bottom: 10px">
                            <div class="fork-name">${fork.name}</div>
                            <a href="${fork.html_url || '#'}" target="_blank" class="fork-url">${fork.full_name}</a>
                        </div>
                        <div class="status-badge ${fork.isUpToDate ? 'status-updated' : 'status-outdated'}">
                            ${getStatusText(fork)}
                        </div>
                    </div>

                    ${fork.error ? `
                        <div class="error-message">
                            Error: ${fork.errorMessage}
                        </div>
                    ` : `
                        <div class="fork-stats">
                            <div class="stat">
                                <span class="stat-value">${new Date(fork.updated_at).toLocaleDateString()}</span>
                                <span>√öltima actualizaci√≥n</span>
                            </div>
                        </div>
                    `}

                    <div class="fork-actions">
                        <a href="${fork.html_url || '#'}" target="_blank" class="btn btn-small">Ver Fork</a>
                        <a href="${getComparisonUrl(fork)}" target="_blank" class="btn btn-small">Ver Comparaci√≥n</a>
                        ${!fork.error && fork.needsSync && !fork.isUpToDate ? `
                            <button class="btn btn-sync btn-small" onclick="syncFork('${fork.owner?.login || 'unknown'}', '${fork.name || 'unknown'}', this)">
                                Sincronizar
                            </button>
                        ` : ''}
                    </div>

                    <button class="debug-toggle" onclick="toggleDebugInfo('${fork.owner?.login || 'unknown'}-${fork.name || 'unknown'}')">
                        üîç Ver detalles t√©cnicos
                    </button>
                    
                    <div id="debug-${fork.owner?.login || 'unknown'}-${fork.name || 'unknown'}" class="debug-section" style="display: none;">
                        <strong>üîç INFORMACI√ìN DE DEBUG:</strong><br><br>
                        <strong>Repositorio Padre:</strong><br>
                        - Nombre: ${fork.debugInfo?.parentRepo?.name || 'N/A'}<br>
                        - Rama por defecto: ${fork.debugInfo?.parentRepo?.default_branch || 'N/A'}<br>
                        - √öltima actualizaci√≥n: ${fork.debugInfo?.parentRepo?.updated_at || 'N/A'}<br><br>
                        
                        <strong>Fork:</strong><br>
                        - Nombre: ${fork.debugInfo?.fork?.name || fork.full_name}<br>
                        - Rama por defecto: ${fork.debugInfo?.fork?.default_branch || fork.default_branch}<br>
                        - √öltima actualizaci√≥n: ${fork.debugInfo?.fork?.updated_at || fork.updated_at}<br><br>
                        
                        ${fork.error ? `
                        <strong>‚ö†Ô∏è ERROR DETECTADO:</strong><br>
                        - Mensaje: ${fork.errorMessage || 'Error desconocido'}<br>
                        - URLs intentadas: ${fork.debugInfo?.urlsAttempted?.length || 0} formato(s)<br><br>
                        ` : `
                        <strong>üìä Comparaci√≥n exitosa:</strong><br>
                        - URL API: ${fork.debugInfo?.comparisonUrl || 'N/A'}<br>
                        - Estado API: ${fork.debugInfo?.comparison?.status || 'N/A'}<br>
                        - API ahead_by (fork atr√°s): ${fork.debugInfo?.comparison?.api_ahead_by || 0}<br>
                        - API behind_by (fork adelante): ${fork.debugInfo?.comparison?.api_behind_by || 0}<br><br>
                        
                        <strong>üéØ Estado calculado:</strong><br>
                        - Commits adelante (propios del fork): ${fork.aheadBy} commits<br>
                        - Estado GitHub: ${fork.isUpToDate ? 'UP-TO-DATE' : 'OUT-OF-DATE'}<br>
                        - Necesita sync: ${fork.needsSync ? 'S√≠' : 'No'}<br>
                        - Tiene commits propios: ${fork.hasOwnCommits ? 'S√≠' : 'No'}<br><br>
                        `}
                        
                        <strong>üîó Enlaces:</strong><br>
                        - <a href="${getComparisonUrl(fork)}" target="_blank" style="color: #90cdf4;">Ver comparaci√≥n en GitHub</a><br>
                    </div>
                </div>
            `).join('');
        }

        function toggleDebugInfo(forkId) {
            const debugDiv = document.getElementById(`debug-${forkId}`);
            if (debugDiv.style.display === 'none') {
                debugDiv.style.display = 'block';
            } else {
                debugDiv.style.display = 'none';
            }
        }

        async function syncFork(forkOwner, forkName, button) {
            const originalText = button.textContent;
            button.textContent = 'Sincronizando...';
            button.disabled = true;

            // Ocultar todos los forks mientras se hace la sincronizaci√≥n
            hideForks();

            try {
                // USAR VALORES CONSTANTES
                const owner = 'bpm-co';
                const repo = 'BPMs';

                if (!forkOwner || !forkName) {
                    throw new Error('Datos incompletos para sincronizaci√≥n');
                }

                const parentRepo = await makeGitHubRequest(`https://api.github.com/repos/${owner}/${repo}`);
                
                const syncResult = await makeGitHubRequest(
                    `https://api.github.com/repos/${forkOwner}/${forkName}/merge-upstream`,
                    'POST',
                    { branch: parentRepo.default_branch }
                );

                if (syncResult.message?.includes('up to date')) {
                    showMessage(`‚úÖ Fork ${forkOwner}/${forkName} ya est√° actualizado`, 'success');
                } else {
                    showMessage(`‚úÖ Fork ${forkOwner}/${forkName} sincronizado exitosamente`, 'success');
                }

                // Recargar la informaci√≥n de forks despu√©s de la sincronizaci√≥n
                setTimeout(() => {
                    loadForks();
                }, 2000);
                
            } catch (error) {
                console.error(`Sync error:`, error);
                handleSyncError(error, forkOwner, forkName);
                // Mostrar los forks de nuevo si hay error
                showForks();
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        function handleSyncError(error, forkOwner, forkName) {
            let errorMessage = '';
            let suggestion = '';

            try {
                const errorData = JSON.parse(error.message);
                
                switch (errorData.message) {
                    case 'Merge conflict':
                        errorMessage = `‚ùå Conflicto de merge en ${forkOwner}/${forkName}`;
                        suggestion = 'Necesitar√°s resolver los conflictos manualmente en GitHub.';
                        break;
                    case 'Branch was not fast-forwardable':
                        errorMessage = `‚ö†Ô∏è No se puede hacer fast-forward en ${forkOwner}/${forkName}`;
                        suggestion = 'El fork tiene commits propios que impiden la sincronizaci√≥n autom√°tica.';
                        break;
                    default:
                        errorMessage = `‚ùå Error en ${forkOwner}/${forkName}: ${errorData.message}`;
                        suggestion = 'Verifica los permisos del token y que el fork sea v√°lido.';
                }
            } catch {
                if (error.message.includes('403')) {
                    errorMessage = `üîí Sin permisos para sincronizar ${forkOwner}/${forkName}`;
                    suggestion = 'Tu token de GitHub no tiene permisos suficientes.';
                } else if (error.message.includes('404')) {
                    errorMessage = `‚ùì Fork ${forkOwner}/${forkName} no encontrado`;
                    suggestion = 'El fork podr√≠a haber sido eliminado.';
                } else {
                    errorMessage = `‚ùå Error inesperado en ${forkOwner}/${forkName}`;
                    suggestion = error.message;
                }
            }

            showMessage(`${errorMessage}<br><small>${suggestion}</small>`, 'error');
        }

        async function syncAllOutdated() {
            const forksNeedingSync = currentForks.filter(fork => fork.needsSync && !fork.error);
            
            if (forksNeedingSync.length === 0) {
                showMessage('No hay forks que necesiten sincronizaci√≥n', 'info');
                return;
            }

            // Ocultar todos los forks durante la sincronizaci√≥n masiva
            hideForks();
            showMessage(`Iniciando sincronizaci√≥n de ${forksNeedingSync.length} forks...`, 'info');

            // Implementar sincronizaci√≥n masiva aqu√≠...
            // Por ahora solo muestra el mensaje
            setTimeout(() => {
                loadForks();
            }, 3000);
        }

        function exportDebugInfo() {
            // USAR VALORES CONSTANTES
            const owner = 'bpm-co';
            const repo = 'BPMs';
            
            const debugData = {
                timestamp: new Date().toISOString(),
                repository: `${owner}/${repo}`,
                totalForks: currentForks.length,
                summary: {
                    upToDate: currentForks.filter(f => f.isUpToDate).length,
                    outOfDate: currentForks.filter(f => !f.isUpToDate && !f.error).length,
                    needs_sync: currentForks.filter(f => f.needsSync === true).length,
                    has_own_commits: currentForks.filter(f => f.hasOwnCommits === true).length,
                    errors: currentForks.filter(f => f.error === true).length
                },
                forks: currentForks.map(fork => ({
                    name: fork.full_name || 'N/A',
                    github_status: fork.isUpToDate ? 'UP-TO-DATE' : 'OUT-OF-DATE',
                    commits_ahead: fork.aheadBy || 0,
                    needs_sync: fork.needsSync || false,
                    has_own_commits: fork.hasOwnCommits || false,
                    detailed_status: fork.detailedStatus || 'unknown',
                    error: fork.error || false,
                    error_message: fork.errorMessage || null,
                    debug_info: fork.debugInfo || {}
                }))
            };

            const dataStr = JSON.stringify(debugData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `github-fork-debug-${owner}-${repo}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showMessage(`üìã Debug exportado: ${debugData.totalForks} forks (${debugData.summary.outOfDate} desactualizados, ${debugData.summary.needs_sync} necesitan sync)`, 'success');
        }

        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadForks();
            }
        });
    </script>
</body>
</html>